---
- job-template:
    name: '{env}-oom-healthcheck'
    project-type: freestyle
    lab-name: ''
    tenant-name: ''
    scm:
      - git:
          url: 'http://gerrit.onap.org/r/integration'
          branches:
            - '*/master'
          wipe-workspace: false
          skip-tag: true
          timeout: 30
    wrappers:
      - timestamps
    triggers:
      - timed: 'H/15 * * * *'
    builders:
      - shell: |
          #!/bin/bash -x
          rm -rf $WORKSPACE/archives
          mkdir -p $WORKSPACE/archives
          . $WORKSPACE/test/ete/labs/{lab-name}/{tenant-name}-openrc

          RANCHER_IP=$(openstack stack output show onap-oom rancher_vm_ip -c output_value -f value)

          RANCHER_IP=$(openstack stack output show onap-oom rancher_vm_ip -c output_value -f value)
          K8S_IP=$(openstack stack output show onap-oom k8s_1_vm_ip -c output_value -f value)

          ssh-keygen -R $RANCHER_IP
          timeout 15m ssh -o StrictHostKeychecking=no -i ~/.ssh/onap_key ubuntu@$RANCHER_IP  'sudo su -l root -c "/root/oom/kubernetes/robot/ete-k8s.sh onap health"'
          retval=$?

          ROBOT_POD=$(ssh -o StrictHostKeychecking=no -i ~/.ssh/onap_key ubuntu@$RANCHER_IP 'sudo su -c "kubectl --namespace onap get pods"' | grep robot | sed 's/ .*//')
          if [ "$ROBOT_POD" == "" ]; then
            exit 1
          fi
          LOG_DIR=$(ssh -o StrictHostKeychecking=no -i ~/.ssh/onap_key ubuntu@$RANCHER_IP "sudo su -c \"kubectl exec $ROBOT_POD --namespace onap -- ls -1t /share/logs | grep health | head -1\"")
          if [ "$LOG_DIR" == "" ]; then
            exit 2
          fi
          wget --user=robot --password=robot -r -np -nH -nv --cut-dirs=2 -R "index.html*" -P $WORKSPACE/archives/ http://$K8S_IP:30209/logs/$LOG_DIR/
          exit 0
    publishers:
      - integration-robot

- job-template:
    name: '{env}-oom-deploy'
    project-type: freestyle
    lab-name: ''
    tenant-name: ''
    scm:
      - git:
          url: 'http://gerrit.onap.org/r/integration'
          branches:
            - '*/master'
          wipe-workspace: false
          skip-tag: true
          timeout: 30
    wrappers:
      - timestamps
    builders:
      - shell: |
          #!/bin/bash -x
          rm -rf $WORKSPACE/archives
          mkdir -p $WORKSPACE/archives

          . $WORKSPACE/test/ete/labs/{lab-name}/{tenant-name}-openrc

          cd $WORKSPACE/deployment/heat/onap-oom
          $WORKSPACE/deployment/heat/onap-oom/scripts/deploy.sh ./env/{lab-name}/{tenant-name}.env
    publishers:
      - integration-robot
