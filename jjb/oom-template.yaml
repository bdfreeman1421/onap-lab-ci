---
- job-template:
    name: '{env}-oom-healthcheck'
    project-type: freestyle
    lab-name: ''
    tenant-name: ''
    scm:
      - integration-master
    wrappers:
      - timestamps
    triggers:
      - timed: 'H/15 * * * *'
    properties:
      - build-blocker:
          blocking-jobs:
            - "{env}-oom-deploy"
    builders:
      - run-oom-ete-tag:
          lab-name: '{lab-name}'
          tenant-name: '{tenant-name}'
          robot-tag: 'health'
    publishers:
      - integration-robot

- job-template:
    name: '{env}-oom-healthdist-resilience'
    project-type: freestyle
    lab-name: ''
    tenant-name: ''
    scm:
      - integration-master
    wrappers:
      - timestamps
    triggers:
      - timed: 'H/10 * * * *'
    properties:
      - build-blocker:
          blocking-jobs:
            - "{env}-oom-deploy"
            - "{env}-oom-healthcheck"
    builders:
      - shell: |
          #!/bin/bash
          set +x
          . $WORKSPACE/deployment/heat/onap-oom/env/{lab-name}/{tenant-name}-openrc
          . $JENKINS_HOME/onap-lab-ci/labs/{lab-name}-openrc
          source $WORKSPACE/test/ete/scripts/install_openstack_cli.sh

          set -x
          rm -rf $WORKSPACE/archives
          mkdir -p $WORKSPACE/archives

          SSH_KEY=~/.ssh/onap_key
          RANCHER_IP=$(openstack stack output show onap-oom rancher_vm_ip -c output_value -f value)
          K8S_IP=$(openstack stack output show onap-oom k8s_1_vm_ip -c output_value -f value)
          ssh-keygen -R $RANCHER_IP

          ROBOT_POD=$(echo "kubectl -n onap get pods | grep robot | sed 's/ .*//'" | ssh -i $SSH_KEY -o StrictHostKeychecking=no ubuntu@$RANCHER_IP sudo su)
          if [ "$ROBOT_POD" == "" ]; then
            exit 1
          fi

          touch $WORKSPACE/kill-history.txt
          GREP_TO_KILL=$( {{ cat $JENKINS_HOME/onap-lab-ci/jobs/$JOB_NAME/kill-list.txt; awk '{{print $1}}' < $WORKSPACE/kill-history.txt; }} | sort | uniq -c | sort -n | head -1 | awk '{{print $2}}')
          POD_TO_KILL=$(echo "kubectl -n onap get pods | grep dev-$GREP_TO_KILL- | sed 's/ .*//' | head -1" | ssh -i $SSH_KEY -o StrictHostKeychecking=no ubuntu@$RANCHER_IP sudo su)
          echo "$GREP_TO_KILL $POD_TO_KILL $BUILD_NUMBER $(date -Is)" >> $WORKSPACE/kill-history.txt
          echo "kubectl -n onap delete pod $POD_TO_KILL" | ssh -i $SSH_KEY -o StrictHostKeychecking=no ubuntu@$RANCHER_IP sudo su
          sleep 5m

          ssh -i $SSH_KEY ubuntu@$RANCHER_IP  'sudo su -l root -c "/root/oom/kubernetes/robot/ete-k8s.sh onap healthdist"'
          retval=$?

          LOG_DIR=$(echo "kubectl exec -n onap $ROBOT_POD -- ls -1t /share/logs | grep healthdist | head -1" | ssh -i $SSH_KEY ubuntu@$RANCHER_IP sudo su)
          if [ "$LOG_DIR" == "" ]; then
            exit 1
          fi

          echo "kubectl cp -n onap $ROBOT_POD:share/logs/$LOG_DIR /tmp/robot/logs/$LOG_DIR" | ssh -i $SSH_KEY ubuntu@$RANCHER_IP sudo su
          rsync -e "ssh -i $SSH_KEY" -avtz ubuntu@$RANCHER_IP:/tmp/robot/logs/$LOG_DIR/ $WORKSPACE/archives/

          echo "Browse Robot results at http://$K8S_IP:30209/logs/$LOG_DIR/"

          exit 0
    publishers:
      - integration-robot

- job-template:
    name: '{env}-oom-instantiate'
    project-type: freestyle
    lab-name: ''
    tenant-name: ''
    scm:
      - integration-master
    wrappers:
      - timestamps
    triggers:
      - reverse:
          jobs:
            - "{env}-oom-deploy"
    properties:
      - build-blocker:
          blocking-jobs:
            - "{env}-oom-deploy"
            - "{env}-oom-healthcheck"
    builders:
      - shell: |
          #!/bin/bash
          set +x
          . $WORKSPACE/deployment/heat/onap-oom/env/{lab-name}/{tenant-name}-openrc
          . $JENKINS_HOME/onap-lab-ci/labs/{lab-name}-openrc
          source $WORKSPACE/test/ete/scripts/install_openstack_cli.sh

          set -x
          rm -rf $WORKSPACE/archives
          mkdir -p $WORKSPACE/archives

          SSH_KEY=~/.ssh/onap_key
          RANCHER_IP=$(openstack stack output show onap-oom rancher_vm_ip -c output_value -f value)
          K8S_IP=$(openstack stack output show onap-oom k8s_1_vm_ip -c output_value -f value)
          ssh-keygen -R $RANCHER_IP

          ROBOT_POD=$(echo "kubectl -n onap get pods | grep robot | sed 's/ .*//'" | ssh -i $SSH_KEY -o StrictHostKeychecking=no ubuntu@$RANCHER_IP sudo su)
          if [ "$ROBOT_POD" == "" ]; then
            exit 1
          fi

          ssh -i $SSH_KEY ubuntu@$RANCHER_IP  'sudo su -l root -c "/root/oom/kubernetes/robot/demo-k8s.sh onap init"'

          ssh -i $SSH_KEY ubuntu@$RANCHER_IP  'sudo su -l root -c "/root/oom/kubernetes/robot/ete-k8s.sh onap healthdist"'

          ssh -i $SSH_KEY ubuntu@$RANCHER_IP  'sudo su -l root -c "/root/oom/kubernetes/robot/ete-k8s.sh onap instantiate"'
          retval=$?

          LOG_DIR=$(echo "kubectl exec -n onap $ROBOT_POD -- ls -1t /share/logs | grep instantiate | head -1" | ssh -i $SSH_KEY ubuntu@$RANCHER_IP sudo su)
          if [ "$LOG_DIR" == "" ]; then
            exit 1
          fi

          echo "kubectl cp -n onap $ROBOT_POD:share/logs/$LOG_DIR /tmp/robot/logs/$LOG_DIR" | ssh -i $SSH_KEY ubuntu@$RANCHER_IP sudo su
          rsync -e "ssh -i $SSH_KEY" -avtz ubuntu@$RANCHER_IP:/tmp/robot/logs/$LOG_DIR/ $WORKSPACE/archives/

          echo "Browse Robot results at http://$K8S_IP:30209/logs/$LOG_DIR/"

          exit 0
    publishers:
      - integration-robot

- job-template:
    name: '{env}-oom-deploy'
    project-type: freestyle
    lab-name: ''
    tenant-name: ''
    scm:
      - integration-master
    wrappers:
      - timestamps
    builders:
      - shell: |
          #!/bin/bash
          set +x
          . $WORKSPACE/deployment/heat/onap-oom/env/{lab-name}/{tenant-name}-openrc
          . $JENKINS_HOME/onap-lab-ci/labs/{lab-name}-openrc
          source $WORKSPACE/test/ete/scripts/install_openstack_cli.sh

          set -x
          rm -rf $WORKSPACE/archives
          mkdir -p $WORKSPACE/archives

          cd $WORKSPACE/deployment/heat/onap-oom
          $WORKSPACE/deployment/heat/onap-oom/scripts/deploy.sh ./env/{lab-name}/{tenant-name}.env
    publishers:
      - integration-robot

- builder:
    name: run-oom-ete-tag
    builders:
      - shell: |
          #!/bin/bash
          set +x
          . $WORKSPACE/deployment/heat/onap-oom/env/{lab-name}/{tenant-name}-openrc
          . $JENKINS_HOME/onap-lab-ci/labs/{lab-name}-openrc
          source $WORKSPACE/test/ete/scripts/install_openstack_cli.sh

          set -x
          rm -rf $WORKSPACE/archives
          mkdir -p $WORKSPACE/archives

          SSH_KEY=~/.ssh/onap_key
          RANCHER_IP=$(openstack stack output show onap-oom rancher_vm_ip -c output_value -f value)
          K8S_IP=$(openstack stack output show onap-oom k8s_1_vm_ip -c output_value -f value)
          ssh-keygen -R $RANCHER_IP

          ROBOT_POD=$(echo "kubectl -n onap get pods | grep robot | sed 's/ .*//'" | ssh -i $SSH_KEY -o StrictHostKeychecking=no ubuntu@$RANCHER_IP sudo su)
          if [ "$ROBOT_POD" == "" ]; then
            exit 1
          fi

          echo "/root/oom/kubernetes/robot/ete-k8s.sh onap {robot-tag}" | ssh -i $SSH_KEY ubuntu@$RANCHER_IP sudo su
          retval=$?

          LOG_DIR=$(echo "kubectl exec -n onap $ROBOT_POD -- ls -1t /share/logs | grep {robot-tag} | head -1" | ssh -i $SSH_KEY ubuntu@$RANCHER_IP sudo su)
          if [ "$LOG_DIR" == "" ]; then
            exit 1
          fi

          echo "kubectl cp -n onap $ROBOT_POD:share/logs/$LOG_DIR /tmp/robot/logs/$LOG_DIR" | ssh -i $SSH_KEY ubuntu@$RANCHER_IP sudo su
          rsync -e "ssh -i $SSH_KEY" -avtz ubuntu@$RANCHER_IP:/tmp/robot/logs/$LOG_DIR/ $WORKSPACE/archives/

          echo "Browse Robot results at http://$K8S_IP:30209/logs/$LOG_DIR/"

          exit 0
