---
- job-template:
    name: '{env}-oom-healthcheck'
    project-type: freestyle
    lab-name: ''
    tenant-name: ''
    scm:
      - integration-master
    wrappers:
      - timestamps
    triggers:
      - timed: 'H/15 * * * *'
    builders:
      - run-oom-ete-tag:
          lab-name: '{lab-name}'
          tenant-name: '{tenant-name}'
          robot-tag: 'health'
    publishers:
      - integration-robot

- job-template:
    name: '{env}-oom-deploy'
    project-type: freestyle
    lab-name: ''
    tenant-name: ''
    scm:
      - integration-master
    wrappers:
      - timestamps
    builders:
      - shell: |
          #!/bin/bash -x
          rm -rf $WORKSPACE/archives
          mkdir -p $WORKSPACE/archives

          . $WORKSPACE/test/ete/labs/{lab-name}/{tenant-name}-openrc

          cd $WORKSPACE/deployment/heat/onap-oom
          $WORKSPACE/deployment/heat/onap-oom/scripts/deploy.sh ./env/{lab-name}/{tenant-name}.env
    publishers:
      - integration-robot

- builder:
    name: run-oom-ete-tag
    builders:
      - shell: |
          #!/bin/bash -x
          rm -rf $WORKSPACE/archives
          mkdir -p $WORKSPACE/archives
          . $WORKSPACE/test/ete/labs/{lab-name}/{tenant-name}-openrc

          SSH_KEY=~/.ssh/onap_key
          RANCHER_IP=$(openstack stack output show onap-oom rancher_vm_ip -c output_value -f value)
          K8S_IP=$(openstack stack output show onap-oom k8s_1_vm_ip -c output_value -f value)
          ssh-keygen -R $RANCHER_IP

          ROBOT_POD=$(ssh -i $SSH_KEY ubuntu@$RANCHER_IP 'sudo su -c "kubectl -n onap get pods"' | grep robot | sed 's/ .*//')
          if [ "$ROBOT_POD" == "" ]; then
            exit 1
          fi

          echo "/root/oom/kubernetes/robot/ete-k8s.sh onap {robot-tag}" | ssh -i $SSH_KEY ubuntu@$RANCHER_IP sudo su
          retval=$?

          LOG_DIR=$(echo "kubectl exec -n onap $ROBOT_POD -- ls -1t /share/logs | grep {robot-tag} | head -1" | ssh -i $SSH_KEY ubuntu@$RANCHER_IP sudo su)
          if [ "$LOG_DIR" == "" ]; then
            exit 1
          fi

          echo "kubectl cp -n onap $ROBOT_POD:share/logs/$LOG_DIR /tmp/robot/logs/$LOG_DIR" | ssh -i $SSH_KEY ubuntu@$RANCHER_IP sudo su
          rsync -e "ssh -i $SSH_KEY" -avtz ubuntu@$RANCHER_IP:/tmp/robot/logs/$LOG_DIR/ $WORKSPACE/archives/

          echo "Browse Robot results at http://$K8S_IP:30209/logs/$LOG_DIR/"

          exit 0
