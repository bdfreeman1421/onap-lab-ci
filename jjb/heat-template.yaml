---
- job-template:
    name: '{env}-heat-healthcheck'
    project-type: freestyle
    lab-name: ''
    tenant-name: ''
    scm:
      - integration-beijing
    wrappers:
      - timestamps
    triggers:
      - timed: 'H/15 * * * *'
    properties:
      - build-blocker:
          blocking-jobs:
            - "{env}-heat-deploy"
    builders:
      - shell: |
          #!/bin/bash
          set +x
          . $WORKSPACE/test/ete/labs/{lab-name}/{tenant-name}-openrc
          . $JENKINS_HOME/onap-lab-ci/labs/{lab-name}-openrc
          source $WORKSPACE/test/ete/scripts/install_openstack_cli.sh

          set -x
          rm -rf $WORKSPACE/archives
          mkdir -p $WORKSPACE/archives

          $WORKSPACE/test/ete/scripts/run-healthcheck.sh
          exit 0
    publishers:
      - integration-robot

- job-template:
    name: '{env}-heat-instantiate'
    project-type: freestyle
    lab-name: ''
    tenant-name: ''
    scm:
      - integration-beijing
    wrappers:
      - timestamps
    triggers:
      - reverse:
          jobs:
            - "{env}-heat-deploy"
          result: 'unstable'
    properties:
      - build-blocker:
          blocking-jobs:
            - "{env}-heat-deploy"
            - "{env}-heat-healthcheck"
    builders:
      - shell: |
          #!/bin/bash
          set +x
          . $WORKSPACE/test/ete/labs/{lab-name}/{tenant-name}-openrc
          . $JENKINS_HOME/onap-lab-ci/labs/{lab-name}-openrc
          source $WORKSPACE/test/ete/scripts/install_openstack_cli.sh

          set -x
          rm -rf $WORKSPACE/archives
          mkdir -p $WORKSPACE/archives

          cd $WORKSPACE/test/ete/scripts
          ROBOT_IP=$(./get-floating-ip.sh onap-robot)
          echo "ROBOT_IP=$ROBOT_IP"

          if [ "" == "$ROBOT_IP" ]; then
            exit 1
          fi
          SSH_KEY=~/.ssh/onap_key
          ssh-keygen -R $ROBOT_IP

          ssh -o StrictHostKeychecking=no -i $SSH_KEY root@$ROBOT_IP "/opt/demo.sh init"

          ssh -i $SSH_KEY root@$ROBOT_IP "/opt/ete.sh healthdist"

          ssh -i $SSH_KEY root@$ROBOT_IP "/opt/ete.sh distribute"

          ssh -i $SSH_KEY root@$ROBOT_IP "/opt/ete.sh instantiate"

          LOG_DIR=$(ssh -i $SSH_KEY root@$ROBOT_IP "ls -1t /opt/eteshare/logs | grep instantiate | head -1")
          echo "Browse Robot results at http://$ROBOT_IP:88/logs/$LOG_DIR/"
          rsync -e "ssh -i $SSH_KEY" -avz root@$ROBOT_IP:/opt/eteshare/logs/$LOG_DIR/ $WORKSPACE/archives/
          exit 0
    publishers:
      - integration-robot

- job-template:
    name: '{env}-heat-stability72hr'
    project-type: freestyle
    lab-name: ''
    tenant-name: ''
    scm:
      - integration-beijing
    wrappers:
      - timestamps
    triggers:
      - timed: '0,30 * * * *'
    properties:
      - build-blocker:
          blocking-jobs:
            - "{env}-heat-deploy"
            - "{env}-heat-healthcheck"
    builders:
      - shell: |
          #!/bin/bash
          set +x
          . $WORKSPACE/test/ete/labs/{lab-name}/{tenant-name}-openrc
          . $JENKINS_HOME/onap-lab-ci/labs/{lab-name}-openrc
          source $WORKSPACE/test/ete/scripts/install_openstack_cli.sh

          set -x
          rm -rf $WORKSPACE/archives
          mkdir -p $WORKSPACE/archives

          cd $WORKSPACE/test/ete/scripts
          ROBOT_IP=$(./get-floating-ip.sh onap-robot)
          echo "ROBOT_IP=$ROBOT_IP"

          if [ "" == "$ROBOT_IP" ]; then
            exit 1
          fi
          SSH_KEY=~/.ssh/onap_key
          ssh-keygen -R $ROBOT_IP

          ssh -o StrictHostKeychecking=no -i $SSH_KEY root@$ROBOT_IP "/opt/ete.sh stability72hr"

          LOG_DIR=$(ssh -i $SSH_KEY root@$ROBOT_IP "ls -1t /opt/eteshare/logs | grep instantiate | head -1")
          echo "Browse Robot results at http://$ROBOT_IP:88/logs/$LOG_DIR/"
          rsync -e "ssh -i $SSH_KEY" -avz root@$ROBOT_IP:/opt/eteshare/logs/$LOG_DIR/ $WORKSPACE/archives/
          exit 0
    publishers:
      - integration-robot

- job-template:
    name: '{env}-heat-deploy'
    project-type: freestyle
    lab-name: ''
    tenant-name: ''
    scm:
      - integration-beijing
    wrappers:
      - timestamps
    builders:
      - shell: |
          #!/bin/bash
          set +x
          . $WORKSPACE/test/ete/labs/{lab-name}/{tenant-name}-openrc
          . $JENKINS_HOME/onap-lab-ci/labs/{lab-name}-openrc
          source $WORKSPACE/test/ete/scripts/install_openstack_cli.sh

          set -x
          $WORKSPACE/test/ete/scripts/deploy-onap.sh {lab-name}
          if [ $? -ne 0 ]; then
            exit 1
          fi

          # retry every 15 minutes for up to 2 hours
          n=0
          until [ $n -ge 8 ]
          do
            sleep 15m
            $WORKSPACE/test/ete/scripts/run-healthcheck.sh && break
            n=$[$n+1]
          done
    publishers:
      - integration-robot
